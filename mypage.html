<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイページ - GaiaProtocol</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://download.playfab.com/PlayFab.js"></script>
    <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
    <style>
      body { font-family: "Segoe UI", sans-serif; background: radial-gradient(circle at center,#030787,#000); color:#fff; margin:0; padding:0; }
      header, footer { background: rgba(10,10,30,0.8); padding:12px 20px; }
      .container { max-width:1000px; margin:24px auto; padding:0 16px; }
      .panel { background: rgba(255,255,255,0.03); padding:18px; border-radius:10px; }
      .flex { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
      .profile-box { width:320px; padding:16px; border-radius:10px; background: rgba(0,0,0,0.35); text-align:center; }
      .icon { width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.08); display:block; margin:0 auto 12px; background:#111; }
      label { display:block; margin:6px 0 4px; font-size:0.95rem; color:#d7e7ff; }
      input[type=text], input[type=email], textarea { width:100%; padding:8px 10px; border-radius:6px; border: none; background: rgba(255,255,255,0.04); color: #fff; }
      textarea { min-height:100px; resize:vertical; }
      button { padding:10px 14px; background: linear-gradient(90deg,#4b5eff,#8f7bff); border:none; border-radius:8px; color:#fff; cursor:pointer; }
      .small { font-size:0.9rem; color:#c9d9ff; }
      .muted { color:#aab8ff; font-size:0.9rem; }
      .error { color:#ffb3b3; }
    </style>
  </head>
<body>
  <header>
    <nav>
      <ul class="menu">
        <li><a href="index.html">ゲーム紹介</a></li>
        <li><a href="progress.html">ゲームの進捗(Xより)</a></li>
        <li><a href="preregister.html">事前登録</a></li>
        <li><a href="team.html">開発者のプロフィール</a></li>
        <li><a href="mypage.html" class="active">マイページ</a></li>
      </ul>
    </nav>
  </header>

  
  <main class="container">
    <h1 style="margin-top:18px;">マイページ</h1>

    <div id="status" class="muted" style="margin-bottom:12px;">準備中</div>

    <div class="panel">
      <!-- ログインフォーム -->
      <section id="loginPanel">
        <h2>ログイン</h2>
        <div style="max-width:420px;">
          <label>メールアドレス</label>
          <input id="loginEmail" type="email" placeholder="example@mail.com" />
          <label>パスワード</label>
          <input id="loginPassword" type="password" placeholder="パスワード" />
          <div style="margin-top:12px;">
            <button id="loginBtn">ログイン</button>
            <button id="logoutBtn" style="display:none; margin-left:8px; background:#777;">ログアウト</button>
          </div>
          <p class="small" style="margin-top:8px;">まだアカウントがない？ → 事前登録ページへ</p>
          <div id="loginError" class="error" style="margin-top:8px; display:none;"></div>
        </div>
      </section>

      <!-- マイページ本体（ログイン後表示） -->
      <section id="mypagePanel" style="display:none; margin-top:18px;">
        <div class="flex">
          <!-- プロフィール表示 -->
          <div class="profile-box">
            <img id="userIcon" class="icon" src="image/default_icon.png" alt="アイコン" />
            <h3 id="displayNickname">—</h3>
            <p id="displayProfile" class="muted">自己紹介がありません</p>
            <div style="margin-top:8px;"><strong id="displayLevel">Lv. 1</strong></div>
          </div>

          <!-- プロフィール編集フォーム -->
          <div style="flex:1; min-width:280px;">
            <h3>プロフィール編集</h3>

            <label>ニックネーム（日本語可）</label>
            <input id="editNickname" type="text" placeholder="例：ぎょー" />

            <label>自己紹介（日本語可）</label>
            <textarea id="editProfile" placeholder="自己紹介を入力"></textarea>

            <label>アイコン画像（外部URL）</label>
            <input id="editIconUrl" type="text" placeholder="https://example.com/icon.png" />

            <label>またはローカル画像をアップ</label>
            <input id="editIconFile" type="file" accept="image/*" />

            <div style="margin-top:10px;">
              <button id="saveProfileBtn">保存する</button>
              <span class="small" style="margin-left:10px;">(画像は外部URL推奨／DataURLはサイズ制限あり)</span>
            </div>

            <div id="saveMsg" class="small" style="margin-top:8px; display:none;"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p>© 2025 GaiaProtocol</p>
  </footer>

  <script>
    // ===== 設定 =====
    PlayFab.settings.titleId = "1FEC7E"; // ← 必ず変更
    const SESSION_KEY = "PlayFabSessionTicket_v1";
    const PLAYFAB_ID_KEY = "PlayFabId_v1";

    // ===== ヘルパー: Base64 UTF-8 encode/decode（日本語対応） =====
    function encodeUTF8Base64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
    function decodeUTF8Base64(b64) {
      try { return decodeURIComponent(escape(atob(b64))); }
      catch (e) { return ""; }
    }


    // ===== UI 要素 =====
    const statusEl = document.getElementById("status");
    const loginPanel = document.getElementById("loginPanel");
    const mypagePanel = document.getElementById("mypagePanel");
    const loginError = document.getElementById("loginError");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");

    const userIcon = document.getElementById("userIcon");
    const displayNickname = document.getElementById("displayNickname");
    const displayProfile = document.getElementById("displayProfile");
    const displayLevel = document.getElementById("displayLevel");

    const editNickname = document.getElementById("editNickname");
    const editProfile = document.getElementById("editProfile");
    const editIconUrl = document.getElementById("editIconUrl");
    const editIconFile = document.getElementById("editIconFile");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const saveMsg = document.getElementById("saveMsg");

    // ===== 画像を10MB以下に圧縮 =====
    async function compressImage(file, maxMB = 10) {
      const img = await createImageBitmap(file);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      let quality = 0.95;
      let blob;
      do {
        blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", quality));
        quality -= 0.05;
      } while (blob.size > maxMB * 1024 * 1024 && quality > 0.1);

      return blob;
    }

    // ===== PlayFab File Upload APIを使ってアップロード =====
    async function uploadFileToPlayFab(file) {
      return new Promise(async (resolve, reject) => {
        try {
          // ① 圧縮
          const compressed = await compressImage(file, 10);
          console.log("圧縮後サイズ:", (compressed.size / 1024 / 1024).toFixed(2), "MB");

          // ② InitiateFileUploads 呼び出し
          PlayFabClientSDK.InitiateFileUploads({
            FileNames: ["user_icon.jpg"]
          }, async (initRes, initErr) => {
            if (initErr || !initRes?.data?.UploadDetails?.length) {
              console.error("InitiateFileUploads error:", initErr);
              reject("アップロードURLの取得に失敗しました。");
              return;
            }

            const uploadUrl = initRes.data.UploadDetails[0].UploadUrl;
            const fileName = initRes.data.UploadDetails[0].FileName;

            // ③ 実際にファイルをPUTでアップロード
            await fetch(uploadUrl, {
              method: "PUT",
              body: compressed,
              headers: { "Content-Type": "image/jpeg" }
            });

            // ④ FinalizeFileUploads 呼び出し
            PlayFabClientSDK.FinalizeFileUploads({ 
              FileNames: [fileName]
            }, (finRes, finErr) => {
              if (finErr) {
                console.error("FinalizeFileUploads error:", finErr);
                reject("ファイルの確定に失敗しました。");
                return;
              }

              const url = finRes.data.Metadata?.[fileName]?.DownloadUrl;
              resolve(url || "");
            });
          });
        } catch (e) {
          console.error(e);
          reject("画像アップロード中にエラーが発生しました。");
        }
      });
    }

    

    // ===== セッション保存/復元 =====
    function saveSession(ticket, playfabId) {
      localStorage.setItem(SESSION_KEY, ticket);
      localStorage.setItem(PLAYFAB_ID_KEY, playfabId || "");
      // SDK内部にセッションを設定（次回の呼び出しで自動使用）
      PlayFab._internalSettings.sessionTicket = ticket;
    }
    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
      localStorage.removeItem(PLAYFAB_ID_KEY);
      PlayFab._internalSettings.sessionTicket = null;
    }
    function getSavedSession() {
      return localStorage.getItem(SESSION_KEY);
    }
    
    // ===== 初期化：保存セッションがあれば自動ログイン状態にする =====
    window.addEventListener("load", () => {
      const ticket = getSavedSession();
      if (ticket) {
        statusEl.textContent = "自動ログインを試行しています...";
        PlayFab.internalSettings.sessionTicket = ticket;  //here
        // 確認のため GetAccountInfo を呼んで当たり判定（軽い）
        PlayFabClientSDK.GetAccountInfo({}, (res) => {
          // 有効なセッション
          statusEl.textContent = "ログイン済みです";
          showMyPage();
        }, (err) => {
          console.warn("保存セッション無効:", err);
          clearSession();
          statusEl.textContent = "セッションが無効です。再ログインしてください。";
        });
      } else {
        statusEl.textContent = "ログインしてください";
        showLogin();
      }
    });


    // ===== 表示切替 =====
    function showLogin() {
      loginPanel.style.display = "block";
      mypagePanel.style.display = "none";
      logoutBtn.style.display = "none";
    }
    function showMyPage() {
      loginPanel.style.display = "none";
      mypagePanel.style.display = "block";
      logoutBtn.style.display = "inline-block";
      loadProfile();
    }

    // ===== ログイン処理 =====
    loginBtn.addEventListener("click", () => {
      loginError.style.display = "none";
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      if (!email || !password) {
        loginError.textContent = "メールとパスワードを入力してください";
        loginError.style.display = "block";
        return;
      }
      statusEl.textContent = "ログイン中...";
      PlayFabClientSDK.LoginWithEmailAddress({
        TitleId: PlayFab.settings.titleId,
        Email: email,
        Password: password
      }, (res) => {
        console.log("Login success:", res);
        const ticket = res.data?.SessionTicket;
        const pfid = res.data?.PlayFabId || "";
        if (ticket) saveSession(ticket, pfid);
        statusEl.textContent = "ログインしました";
        showMyPage();
      }, (err) => {
        console.error("Login error:", err);
        loginError.textContent = err?.errorMessage || "ログインに失敗しました";
        loginError.style.display = "block";
        statusEl.textContent = "ログイン失敗";
      });
    });

    // ログアウト
    logoutBtn.addEventListener("click", () => {
      clearSession();
      loginEmail.value = "";
      loginPassword.value = "";
      statusEl.textContent = "ログアウトしました";
      showLogin();
    });

    // ===== プロフィール読み込み =====
    function loadProfile() {
      statusEl.textContent = "プロフィール読み込み中...";
      PlayFabClientSDK.GetUserData({}, (res) => {
        const data = (res.data && res.data.Data) || {};
        const nickB64 = data.nickname?.Value;
        const profB64 = data.profile?.Value;
        const level = data.level?.Value || "1";
        const icon = data.icon_url?.Value || data.user_icon?.Value || "image/default_icon.png";

        const nick = nickB64 ? decodeUTF8Base64(nickB64) : "（未設定）";
        const prof = profB64 ? decodeUTF8Base64(profB64) : "自己紹介がありません";

        displayNickname.textContent = nick;
        displayProfile.textContent = prof;
        displayLevel.textContent = "Lv. " + level;
        userIcon.src = icon;

        // 編集フォームに反映
        editNickname.value = nick === "（未設定）" ? "" : nick;
        editProfile.value = prof === "自己紹介がありません" ? "" : prof;
        editIconUrl.value = (icon && icon !== "image/default_icon.png") ? icon : "";

        statusEl.textContent = "プロフィール表示中";
      }, (err) => {
        console.error("GetUserData error:", err);
        statusEl.textContent = "プロフィールの読み込みに失敗しました";
      });
      



      // ===== プロフィール保存 =====
      saveProfileBtn.addEventListener("click", async () => {
        saveMsg.style.display = "none";
        const nick = editNickname.value.trim();
        const prof = editProfile.value.trim();
        const url = editIconUrl.value.trim();
        const file = editIconFile.files[0];

        if (!nick) {
          saveMsg.textContent = "ニックネームは必須です";
          saveMsg.style.display = "block";
          return;
        }  

        const dataToSave = {
          nickname: encodeUTF8Base64(nick),
          profile: encodeUTF8Base64(prof || "")
        };

        statusEl.textContent = "プロフィール保存中...";
        saveMsg.textContent = "保存中...";
        saveMsg.style.display = "block";

        try {
          let finalIconUrl = url;

          // ファイルがある場合はPlayFabにアップロード
          if (file && !url) {
            saveMsg.textContent = "画像アップロード中...";
            finalIconUrl = await uploadFileToPlayFab(file);
            console.log("アップロード完了URL:", finalIconUrl);
          }

          if (finalIconUrl) {
            dataToSave.icon_url = finalIconUrl;
          }

          // ⑤ プロフィール保存
          PlayFabClientSDK.UpdateUserData({ Data: dataToSave }, (res) => {
            console.log("UpdateUserData success:", res);
            saveMsg.textContent = "保存しました！";
            statusEl.textContent = "プロフィールを保存しました";
            setTimeout(loadProfile, 700);
          }, (err) => {
            console.error("UpdateUserData error:", err);
            saveMsg.textContent = "保存に失敗しました: " + (err?.errorMessage || JSON.stringify(err));
          });
        } catch (e) {
          console.error(e);
          saveMsg.textContent = "画像アップロードに失敗しました: " + e;
        }  
      });
    </script>
</body>
</html>
