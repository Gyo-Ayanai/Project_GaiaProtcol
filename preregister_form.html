<!DOCTYPE html>
<html lang="ja">
  <head>
    <script src="https://download.playfab.com/PlayFab.js"></script>
    <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>事前登録 - GaiaProtocol</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: radial-gradient(circle at center, #030787, #000);
        color: #fff;
        text-align: center;
        padding: 30px;
      }

      h1 {
        margin-bottom: 10px;
        color: #88f7ff;
      }

      p {
        color: #ccc;
        margin-bottom: 20px;
      }

      form {
        background: rgba(255, 255, 255, 0.05);
        padding: 25px;
        border-radius: 10px;
        display: inline-block;
        text-align: left;
        width: 300px;
      }

      .terms-wrap {
        background: rgba(255, 255, 255, 0.08);
        padding: 15px;
        margin: 20px auto;
        border-radius: 8px;
        width: 85%;
        max-width: 400px;
        text-align: left;
      }

      #termsBox, #privacyBox {
        height: 150px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
        border-radius: 5px;
        color: #ccc;
        font-size: 0.9rem;
      }

      .terms-actions {
        font-size: 0.8rem;
        margin-top: 5px;
        color: #aaa;
      }

      input[type="checkbox"] {
        margin-right: 5px;
      }

      input {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: none;
        border-radius: 5px;
        outline: none;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 15px;
      }

      input::placeholder {
        color: #aaa;
      }

      button {
        background: linear-gradient(90deg, #00c3ff, #0078ff);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
      }

      button:hover {
        background: linear-gradient(90deg, #00eaff, #0090ff);
      }

      footer {
        margin-top: 50px;
        color: #555;
      }

      @media screen and (max-width: 600px) {
        form {
          width: 85%;
        }
      }
    </style>
  </head>

  <body>
    <main>
      <h1>アカウント事前登録</h1>
      <p>メールアドレス、ユーザー名、パスワードを入力してください。</p>

      <!-- 利用規約 -->
      <section class="terms-wrap">
        <h2>利用規約</h2>
        <div id="termsBox">読み込み中...</div>
        <div class="terms-actions">
          <small>最後までスクロールすると同意チェックが有効になります。／
            <a href="利用規約.txt" download>利用規約をダウンロード</a>
          </small>
        </div>
        <label><input type="checkbox" id="agreeTerms" disabled />利用規約に同意します</label>
      </section>

      <!-- プライバシーポリシー -->
      <section class="terms-wrap">
        <h2>プライバシーポリシー</h2>
        <div id="privacyBox">読み込み中...</div>
        <div class="terms-actions">
          <small>最後までスクロールすると同意チェックが有効になります。／
            <a href="policy.txt" download>プライバシーポリシーをダウンロード</a>
          </small>
        </div>
        <label><input type="checkbox" id="agreePrivacy" disabled />プライバシーポリシーに同意します</label>
      </section>
      
      <form id="registerForm">
        <input type="email" id="email" placeholder="メールアドレス" required disabled/><br />
        <input type="text" id="username" placeholder="ユーザー名" required disabled/><br />
        <input type="password" id="password" placeholder="パスワード（6文字以上）" required disabled/><br />
        <input type="password" id="confirmPassword" placeholder="パスワード（確認用）" required disabled/><br />
        <button type="submit" id="registerButton" disabled>登録する</button>
        <p id="formNote" style="color:#aaa; margin-top:10px; margin-bottom:0;">
          すべての規約に同意すると入力できます
        </p>
      </form>

      <p id="result" style="margin-top: 30px; color: #f0a500"></p>
    </main>

    <footer>
      <p>© 2025 GaiaProtocol</p>
    </footer>

    <script>
      const titleId = "1FEC7E";
      const web3formsKey = "96cfe88e-9989-49d8-b3b7-3c4d88fb821c";
      PlayFab.settings.titleId = titleId;

      window.onload = () => {
        const form = document.getElementById("registerForm");
        const result = document.getElementById("result");
        const termsBox = document.getElementById("termsBox");
        const privacyBox = document.getElementById("privacyBox");
        const agreeTerms = document.getElementById("agreeTerms");
        const agreePrivacy = document.getElementById("agreePrivacy");
        const registerButton = document.getElementById("registerButton");
        const inputs = document.querySelectorAll("#email, #username, #password, #confirmPassword");

      // 🔹 利用規約とプライバシーポリシーの読み込み
        
        function loadText(url, box) {
          fetch(url, { cache: "no-store" })
            .then(r => r.ok ? r.text() : Promise.reject("読み込み失敗"))
            .then(text => box.textContent = text)
            .catch(() => box.textContent = "読み込みに失敗しました。");
        }
        loadText("利用規約.txt", termsBox);
        loadText("policy.txt", privacyBox);
        

      // 🔹 スクロール確認関数
        function checkScrollEnd(box, checkbox) {
          const epsilon = 2;
          if (box.scrollTop + box.clientHeight >= box.scrollHeight - epsilon) {
            checkbox.disabled = false;
          }
        }

        termsBox.addEventListener("scroll", () => checkScrollEnd(termsBox, agreeTerms));
        privacyBox.addEventListener("scroll", () => checkScrollEnd(privacyBox, agreePrivacy));

      // 🔹 両方チェックされたらフォーム有効化
        function updateFormState() {
          const enabled = agreeTerms.checked && agreePrivacy.checked;
          inputs.forEach(i => i.disabled = !enabled);
          registerButton.disabled = !enabled;
        }

        agreeTerms.addEventListener("change", updateFormState);
        agreePrivacy.addEventListener("change", updateFormState);

      // 🔹 フォーム送信
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          result.innerText = "⏳ 登録中...";

        if (!agree.checked) {
          result.innerText = "⚠️ 利用規約に同意してください。";
          return;
        }
        if (password !== confirmPassword) {
          result.innerText = "⚠️ パスワードが一致しません。";
          return;
        }
        if (password.length < 6) {
          result.innerText = "⚠️ パスワードは6文字以上にしてください。";
          return;
        }

        result.innerText = "⏳ 登録中...";

        try {
          PlayFabClientSDK.RegisterPlayFabUser(
            {
              TitleId: PlayFab.settings.titleId,
              Email: email,
              Password: password,
              Username: username,
              RequireBothUsernameAndEmail: true,
            },
            async (success) => {
              result.innerText = "✅ 登録成功！データ保存中...";

              PlayFabClientSDK.UpdateUserData(
                {
                  Data: {
                    pre_registered: "true",
                    register_date: new Date().toISOString(),
                  },
                },
                async () => {
                  result.innerText = "📧 メール送信中...";
                  try {
                    await fetch("https://api.web3forms.com/submit", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        access_key: web3formsKey,
                        subject: "【GaiaProtocol運営】事前登録ありがとうございます！",
                        from_name: "GaiaProtocol",
                        to: email,
                        message: `こんにちは ${username} さん！\n\n『Gaia Protocol』に事前登録いただきありがとうございます！\n\n正式リリースのお知らせを楽しみにお待ちください。\n\n- GaiaProtocol運営チーム`,
                      }),
                    });

                    result.innerText = "🎉 登録完了！トップページに戻ります...";
                    setTimeout(() => (location.href = "index.html"), 2000);
                  } catch (err) {
                    console.error(err);
                    result.innerText = "⚠️ メール送信に失敗しました。";
                  }
                },
                (error) => {
                  console.error(error);
                  result.innerText = "⚠️ データ保存に失敗しました。";
                }
              );
            },
            (error) => {
              console.error(error);
              result.innerText =
                "⚠️ 登録に失敗しました: " + (error?.errorMessage || "不明なエラー");
            }
          );
        } catch (err) {
          console.error(err);
          result.innerText = "⚠️ 通信エラーが発生しました。";
        }
      });

        // （PlayFab登録処理はここにそのまま入れてOK）
      });
    </script>
  </body>
</html>
